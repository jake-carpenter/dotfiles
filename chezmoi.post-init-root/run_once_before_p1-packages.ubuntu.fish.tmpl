#!/usr/bin/env fish

# Hash the packages file to trigger a change here when there's a change there.
# packages.yaml hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

{{ $isUbuntu := and (hasKey .chezmoi.osRelease "id") (eq .chezmoi.osRelease.id "ubuntu") }}

{{ if not $isUbuntu }}
  exit 0
{{ end }}

echo
echo "ğŸš€ Applying PPAs/repositories and installing packages for Ubuntu"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

{{ range .packages.ubuntu.base.repos }}
  set repo {{ . }}

  # Check if PPA is already added by trying a dry-run
  if add-apt-repository --dry-run -y $repo 2>&1 | grep -q "Found existing"
    echo "Repository already exists: $repo"
  else
    echo "Adding repository: $repo"
    sudo add-apt-repository -y $repo
  end
{{ end }}

sudo apt update

# This doesn't handle system profiles for Ubuntu yet.
set packages

{{ range .packages.ubuntu.base.packages }}
  set -a packages {{ . | quote }}
{{ end }}

if test (count $packages) -gt 0
  # Check which packages are missing
  set missing_packages

  for package in $packages
    if not dpkg -l "$package" 2>/dev/null | grep -q "^ii"
      set -a missing_packages $package
    end
  end

  if test (count $missing_packages) -gt 0
    echo "Installing missing packages: $missing_packages"
    sudo apt install -y $missing_packages
  else
    echo "All packages are already installed."
  end
else
  echo "No packages to install."
end
